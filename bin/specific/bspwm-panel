#! /bin/bash

highlight_colour=yellow
empty_colour='#ddd'
urgent_colour='#f64'
max_title_length=25
truncated_title_suffix='[...]'
truncate_title_size="$((max_title_length-${#truncated_title_suffix}))"

bspc control --subscribe | while read; do
    desktop_colour="$highlight_colour"
    [ -z "$(bspc query -W -w last)" ] && \
        [ -z "$(bspc query -W -w focused)" ] && desktop_colour="$empty_colour"
    echo -n "<action=\`bspc desktop -f next\`>\
desktop: <fc=$desktop_colour>$(bspc query -D -d focused)</fc></action>"

    id="$(bspc query -W -w last.urgent)"
    if [ -n "$id" ]; then
        desktop="$(bspc query -D -w "$id")"

        title="$(xwininfo -id "$id" -wm | \
            head -n2 | tail -n1 | sed 's/^.*"\(.*\)"$/\1/')"
        [ "${#title}" -gt "$max_title_length" ] && \
            title="$(
                echo "$title" | head -c"$truncate_title_size"
            )$truncated_title_suffix"

        echo " || <action=\`bspc window -f last.urgent\`>\
[<fc=$highlight_colour>$desktop</fc>] \
<fc=$urgent_colour><raw=${#title}:$title/></fc></action>"
    else
        echo
    fi
done
