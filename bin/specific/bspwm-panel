#! /bin/bash

highlight_colour=yellow
empty_colour='#ddd'
urgent_colour='#f64'
max_title_length=25
truncated_title_suffix='[...]'
truncate_title_size="$((max_title_length-${#truncated_title_suffix}))"

render_desktop () {
    bspc query -T -d "$1" | jshon -e name -u
}

update () {
    desktop_colour="$highlight_colour"
    desktop="$(bspc query -D -d focused)"
    flags=
    [ -z "$(bspc query -N -n last)" ] && desktop_colour="$empty_colour"
    [ "$(bspc query -T -d "$desktop" | jshon -e layout -u)" = monocle ] && flags=" [<fc=$urgent_colour>M</fc>]"
    echo -n "<action=\`bspc desktop -f next\`>\
desktop: <fc=$desktop_colour>$(render_desktop "$desktop")</fc>$flags</action>"

    bspc query -N -n .urgent | while read -r id; do
        desktop="$(bspc query -D -n "$id")"

        title="$(xwininfo -id "$id" -wm | \
            head -n2 | tail -n1 | sed 's/^.*"\(.*\)"$/\1/')"
        [ "${#title}" -gt "$max_title_length" ] && \
            title="$(
                echo "$title" | head -c"$truncate_title_size"
            )$truncated_title_suffix"

        echo -n " || <action=\`bspc node -f last.urgent\`>\
[<fc=$highlight_colour>$(render_desktop "$desktop")</fc>] \
<fc=$urgent_colour><raw=${#title}:$title/></fc></action>"
    done

    echo
}

update
bspc subscribe \
    node_focus node_flag node_remove desktop_focus desktop_layout | \
    while read; do update; done
